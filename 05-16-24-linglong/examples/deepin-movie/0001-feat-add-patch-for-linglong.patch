From 3885aee6ffed9d510a67acce3269c6a0791a3773 Mon Sep 17 00:00:00 2001
From: bluesky <chenchongbiao@deepin.org>
Date: Wed, 15 May 2024 16:19:13 +0800
Subject: [PATCH] feat: add patch for linglong

Log: add patch
---
 examples/test/CMakeLists.txt       |  2 +-
 src/CMakeLists.txt                 | 13 ++++++----
 src/backends/mpv/mpv_proxy.h       | 37 +++++++++++++++++++---------
 src/libdmr/CMakeLists.txt          |  5 ++--
 src/libdmr/compositing_manager.cpp | 39 ++++++++++++++++++++----------
 5 files changed, 63 insertions(+), 33 deletions(-)

diff --git a/examples/test/CMakeLists.txt b/examples/test/CMakeLists.txt
index f2a2e76b..dee00f57 100644
--- a/examples/test/CMakeLists.txt
+++ b/examples/test/CMakeLists.txt
@@ -10,7 +10,7 @@ set(CMD_NAME dmr_test)
 set(CMAKE_CXX_FLAGS "-std=c++1y -fpermissive -Wno-error")
 
 include_directories(${CMAKE_INCLUDE_CURRENT_DIR})
-
+include_directories(/runtime/include)
 find_package(Qt5Widgets)
 find_package(Qt5Concurrent)
 find_package(Qt5Network)
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index f1121fb2..8ee5d653 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -14,7 +14,7 @@ add_definitions(-D_MOVIE_USE_)
 
 include_directories(${CMAKE_INCLUDE_CURRENT_DIR})
 include_directories(${CMAKE_CURRENT_BINARY_DIR})
-
+include_directories(/runtime/include)
 find_package(Qt5Widgets)
 find_package(Qt5DBus)
 find_package(Qt5X11Extras)
@@ -31,7 +31,10 @@ pkg_check_modules(Dtk REQUIRED IMPORTED_TARGET dtkwidget)
 pkg_check_modules(Dtk REQUIRED IMPORTED_TARGET dtkcore)
 pkg_check_modules(Xcb REQUIRED IMPORTED_TARGET xcb xcb-shape)
 pkg_check_modules(DBusextended REQUIRED IMPORTED_TARGET dbusextended-qt5)
-pkg_check_modules(Gst REQUIRED IMPORTED_TARGET gobject-2.0)
+pkg_check_modules(Gob REQUIRED IMPORTED_TARGET gobject-2.0)
+pkg_check_modules(Gst REQUIRED IMPORTED_TARGET gstreamer-1.0)
+pkg_check_modules(Glib REQUIRED IMPORTED_TARGET glib-2.0)
+pkg_check_modules(MPRIS REQUIRED IMPORTED_TARGET mpris-qt5)
 # IMPORTED_TARGET failed to work for some of libs under flatpak env
 pkg_check_modules(Other REQUIRED  gsettings-qt)
 
@@ -51,7 +54,7 @@ file(GLOB_RECURSE MEDIAPLAYER_SRCS LIST_DIRECTORIES false backends/mediaplayer/*
 list(APPEND SRCS ${MPV_SRCS} ${MEDIAPLAYER_SRCS})
 list(APPEND PROJECT_INCLUDE ${PROJECT_SOURCE_DIR}/src/backends/mpv)
 list(APPEND PROJECT_INCLUDE ${PROJECT_SOURCE_DIR}/src/backends/mediaplayer)
-list(APPEND PROJECT_INCLUDE /usr/include/glib-2.0 /usr/include/gstreamer-1.0)
+list(APPEND PROJECT_INCLUDE ${Glib_INCLUDE_DIRS} ${Gst_INCLUDE_DIRS})
 #~
 
 set (DTK_SETTINGS_TOOLS_EXECUTABLE ${DTKCORE_TOOL_DIR}/dtk-settings)
@@ -77,10 +80,10 @@ endif ()
 
 add_executable(${CMD_NAME} ${SRCS} ${RCS} ${QM})
 
-target_include_directories(${CMD_NAME} PUBLIC ${PROJECT_INCLUDE})
+target_include_directories(${CMD_NAME} PUBLIC ${PROJECT_INCLUDE} ${MPRIS_INCLUDE_DIRS})
 
 set(TARGET_LIBS X11 Xtst PkgConfig::Xcb Qt5::Widgets Qt5::X11Extras Qt5::Network Qt5::DBus Qt5::Sql Qt5::Svg Qt5::Multimedia
-    Qt5::MultimediaWidgets PkgConfig::Dtk PkgConfig::MPRIS PkgConfig::DBusextended PkgConfig::Gst GL va va-x11
+    Qt5::MultimediaWidgets PkgConfig::Dtk ${MPRIS_LIBRARIES} PkgConfig::DBusextended PkgConfig::Gob GL va va-x11
     Qt5::Concurrent Qt5::Xml)
 
 target_link_libraries(${CMD_NAME} ${TARGET_LIBS} ${Other_LIBRARIES})
diff --git a/src/backends/mpv/mpv_proxy.h b/src/backends/mpv/mpv_proxy.h
index 18fc5751..b1c54098 100644
--- a/src/backends/mpv/mpv_proxy.h
+++ b/src/backends/mpv/mpv_proxy.h
@@ -38,20 +38,33 @@ typedef void (*mpv_terminateDestroy)(mpv_handle *ctx);
 
 static QString libPath(const QString &sLib)
 {
-    QDir dir;
-    QString path  = QLibraryInfo::location(QLibraryInfo::LibrariesPath);
-    dir.setPath(path);
-    QStringList list = dir.entryList(QStringList() << (sLib + "*"), QDir::NoDotAndDotDot | QDir::Files); //filter name with strlib
-    if (list.contains(sLib)) {
-        return sLib;
-    } else {
-        list.sort();
+    QDir  dir;
+    QStringList environment = QProcess::systemEnvironment();
+    QString str, t_str;
+    foreach (str, environment) {
+        if (str.startsWith("LD_LIBRARY_PATH=")) {
+            t_str = str;
+            break;
+        }
     }
-
-    if(list.size() > 0)
-        return list.last();
-    else
+    if (t_str.isEmpty()) {
         return QString();
+    }
+    qDebug() << t_str;
+    QStringList liststr = t_str.split("=").at(1).split(":");
+    QStringList t_list;
+    QString t_libPath;
+    for (size_t i = 0; i < liststr.count() ; i++) {
+        QString path  = liststr.at(i);
+        dir.setPath(path);
+        QStringList list = dir.entryList(QStringList() << (sLib + "*"), QDir::NoDotAndDotDot | QDir::Files); //filter name with sLib
+        if (!list.isEmpty()) {
+            t_libPath = path + "/" + list.first();
+            break;
+        }
+    }
+    qDebug() << t_libPath;
+    return t_libPath;
 }
 
 class MpvHandle
diff --git a/src/libdmr/CMakeLists.txt b/src/libdmr/CMakeLists.txt
index c264f7e8..a054de07 100644
--- a/src/libdmr/CMakeLists.txt
+++ b/src/libdmr/CMakeLists.txt
@@ -10,7 +10,8 @@ set(CMD_NAME dmr)
 add_definitions(-D_LIBDMR_)
 remove_definitions(-D_MOVIE_USE_)
 
-pkg_check_modules(Gst REQUIRED IMPORTED_TARGET gstreamer-1.0 glib-2.0)
+pkg_check_modules(Gst REQUIRED IMPORTED_TARGET gstreamer-1.0)
+pkg_check_modules(Glib REQUIRED IMPORTED_TARGET glib-2.0)
 
 include_directories(${CMAKE_INCLUDE_CURRENT_DIR})
 
@@ -24,7 +25,7 @@ add_library(${CMD_NAME} SHARED ${SRCS})
 set_target_properties(${CMD_NAME} PROPERTIES VERSION 0.1.0 SOVERSION 0.1)
 
 target_include_directories(${CMD_NAME} PUBLIC
-    ${PROJECT_SOURCE_DIR}/../common ${PROJECT_SOURCE_DIR}/../backends/mediaplayer ${PROJECT_SOURCE_DIR}/../backends/mpv /usr/include/glib-2.0 /usr/include/gstreamer-1.0)
+    ${PROJECT_SOURCE_DIR}/../common ${PROJECT_SOURCE_DIR}/../backends/mediaplayer ${PROJECT_SOURCE_DIR}/../backends/mpv ${Gst_INCLUDE_DIRS} ${Glib_INCLUDE_DIRS})
 
 target_link_libraries(${CMD_NAME} PkgConfig::Dtk Qt5::Widgets Qt5::Concurrent
     Qt5::Network Qt5::X11Extras Qt5::Sql Qt5::Svg Qt5::Multimedia Qt5::MultimediaWidgets Qt5::DBus PkgConfig::Gst GL)
diff --git a/src/libdmr/compositing_manager.cpp b/src/libdmr/compositing_manager.cpp
index 3979abf6..bdd8efe9 100644
--- a/src/libdmr/compositing_manager.cpp
+++ b/src/libdmr/compositing_manager.cpp
@@ -235,22 +235,35 @@ bool CompositingManager::isCanHwdec()
     return m_bCanHwdec;
 }
 
-QString  CompositingManager::libPath(const QString &sLib)
+QString  CompositingManager::libPath(const QString &strlib)
 {
-    QDir dir;
-    QString path  = QLibraryInfo::location(QLibraryInfo::LibrariesPath);
-    dir.setPath(path);
-    QStringList list = dir.entryList(QStringList() << (sLib + "*"), QDir::NoDotAndDotDot | QDir::Files); //filter name with strlib
-    if (list.contains(sLib)) {
-        return (path+ QDir::separator() + sLib);
-    } else {
-        list.sort();
+    QDir  dir;
+    QStringList environment = QProcess::systemEnvironment();
+    QString str, t_str;
+    foreach (str, environment) {
+        if (str.startsWith("LD_LIBRARY_PATH=")) {
+            t_str = str;
+            break;
+        }
     }
-
-    if(list.size() > 0)
-        return (path + QDir::separator() + list.last());
-    else
+    if (t_str.isEmpty()) {
         return QString();
+    }
+    qDebug() << t_str;
+    QStringList liststr = t_str.split("=").at(1).split(":");
+    QStringList t_list;
+    QString t_libPath;
+    for (size_t i = 0; i < liststr.count() ; i++) {
+        QString path  = liststr.at(i);
+        dir.setPath(path);
+        QStringList list = dir.entryList(QStringList() << (strlib + "*"), QDir::NoDotAndDotDot | QDir::Files); //filter name with strlib
+        if (!list.isEmpty()) {
+            t_libPath = path + "/" + list.first();
+            break;
+        }
+    }
+    qDebug() << t_libPath;
+    return t_libPath;
 }
 
 void CompositingManager::setCanHwdec(bool bCanHwdec)
-- 
2.33.1

